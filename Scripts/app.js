if(!Array.prototype.map){Array.prototype.map=function(b,i){var h,a,c;if(this==null){throw new TypeError(" this is null or not defined")}var g=Object(this);var e=g.length>>>0;if(typeof b!=="function"){throw new TypeError(b+" is not a function")}if(arguments.length>1){h=i}a=new Array(e);c=0;while(c<e){var d,f;if(c in g){d=g[c];f=b.call(h,d,c,g);a[c]=f}c++}return a}}if(!Array.prototype.forEach){Array.prototype.forEach=function(a,g){var f,b;if(this==null){throw new TypeError(" this is null or not defined")}var e=Object(this);var d=e.length>>>0;if(typeof a!=="function"){throw new TypeError(a+" is not a function")}if(arguments.length>1){f=g}b=0;while(b<d){var c;if(b in e){c=e[b];a.call(f,c,b,e)}b++}}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(f,a){var b;if(this==null){throw new TypeError('"this" is null or not defined')}var e=Object(this);var c=e.length>>>0;if(c===0){return -1}var d=+a||0;if(Math.abs(d)===Infinity){d=0}if(d>=c){return -1}b=Math.max(d>=0?d:c-Math.abs(d),0);while(b<c){if(b in e&&e[b]===f){return b}b++}return -1}}if(!Array.prototype.every){Array.prototype.every=function(a,h){var f,b;if(this==null){throw new TypeError("this is null or not defined")}var e=Object(this);var d=e.length>>>0;if(typeof a!=="function"){throw new TypeError()}if(arguments.length>1){f=h}b=0;while(b<d){var c;if(b in e){c=e[b];var g=a.call(f,c,b,e);if(!g){return false}}b++}return true}};app={};webix.ready(function(){webix.ui({rows:[{view:"view.toolbar",id:"toolbar",on:{activate:onToolbarActivate}},{cols:[{id:"sidebar",view:"sidebar",collapsed:true,data:[{id:"viewscroll.tablesettings",icon:"table",value:"Data log settings"},{id:"viewscroll.logview",icon:"search",value:"View log data"}],on:{onItemClick:function(a){$$(a).show(false,false)}}},{id:"viewscroll",cells:[{id:"viewscroll.tablesettings",cols:[{view:"view.table_list",id:"table_list",icons:app.settings.icons,on:{tableSelect:onTableSelect}},{view:"resizer"},{view:"view.table_editor",id:"table_editor",icons:app.settings.icons,on:{onTableChange:function(a){$$("table_list").refreshItem(a)}}}]},{id:"viewscroll.logview",cols:[{view:"view.logtable",id:"logtable",gravity:1.5,on:{onSelectChange:onLogTableSelect}},{view:"resizer"},{view:"view.logdetails",id:"logdetails"}]}]}]}]});$$("toolbar").restoreState();$$("sidebar").select("viewscroll.tablesettings")});var onToolbarActivate=function(b){if(!b){app.connection=null;var a=$$("table.table_list");a.disable();a.clearAll();$$("table.log").clearAll();return}app.connection=b;$$("table_list").load(b);$$("logtable").load(b)};var onTableSelect=function(a){$$("table_editor").load(app.connection,a)};var onLogTableSelect=function(a){$$("logdetails").load(a)};app.i18n={};app.settings={icons:{insert:"fa-plus-square-o ",update:"fa-edit","delete":"fa-minus-square-o"},url:{tableList:"ChangeLog/Handlers/SelectTableList.ashx"}};webix.protoUI({name:"view.logdetails",$init:function(a){webix.extend(this.defaults,{disabled:true,rows:[{id:"table.logdetails",view:"datatable",resizeColumn:true,columns:[{id:"Column",header:"Column",fillspace:0.5},{id:"OldValue",header:"OldValue",fillspace:1},{id:"NewValue",header:"NewValue",fillspace:1}]}]})},load:function(a){if(a){this.enable();this.parseXml(a)}else{this.clear();this.disable()}},parseXml:function(a){var c=this["parse_"+a.changeType];var b=c.call(this,a.description);var d=$$("table.logdetails");d.clearAll();d.parse(b)},xmlToObject:function(g){var c=webix.DataDriver.xml.toObject(g);var f=c.childNodes[0];var b=f.attributes;var e={};if(b&&b.length){for(var d=0;d<b.length;d++){e[b[d].name]=b[d].value}}return e},parse_I:function(d){var b=this.xmlToObject(d);var c=[];for(var a in b){c.push({Column:a,NewValue:b[a]})}return c},parse_U:function(g){var f=g.indexOf(">")+1;var a=this.xmlToObject(g.substring(0,f));var b=this.xmlToObject(g.substring(f,g.length));var e=[];var d={};for(var c in b){d[c]=b[c]}for(var c in a){if(!d[c]){d[c]=a[c]}}for(var c in d){e.push({Column:c,OldValue:webix.isUndefined(b[c])?"NULL":b[c],NewValue:webix.isUndefined(a[c])?"NULL":a[c],$css:b[c]==a[c]?"":{"background-color":"papayawhip"}})}return e},parse_D:function(d){var b=this.xmlToObject(d);var c=[];for(var a in b){c.push({Column:a,OldValue:b[a]})}return c},clear:function(){$$("table.logdetails").clearAll()}},webix.ui.layout);webix.protoUI({name:"view.logtable",$init:function(b){var c=webix.Date.dateToStr("%d.%m.%Y %H:%i:%s");var d=this,a=function(e){return webix.bind(d[e],d)};webix.extend(this.defaults,{rows:[{view:"datatable",id:"table.log",resizeColumn:true,columns:[{id:"idChangeLog",header:["Id",{content:"serverFilter"}],width:80,sort:"server"},{id:"date",header:["Date",{content:"serverFilter"}],width:150,sort:"server"},{id:"user",header:["UserName",{content:"serverFilter"}],width:260},{id:"changeType",header:["ChangeType",{content:"serverSelectFilter",options:[{id:"",value:"All"},{id:"I",value:"Insert"},{id:"U",value:"Update"},{id:"D",value:"Delete"}]}],width:100,template:function(f){var e={I:"Insert",U:"Update",D:"Delete"};return e[f.changeType]}},{id:"table",header:["TableName",{content:"serverFilter"}],fillspace:true},{id:"idString",header:["IdString",{content:"serverFilter"}],width:100}],dataThrottle:500,scheme:{$init:function(e){e.date=c(new Date(e.date))}},on:{onBeforeLoad:a("_onBeforeLoad"),onAfterLoad:a("_onAfterLoad"),onSelectChange:a("_onSelectChange")},select:"row",pager:"pagerA"},{paddingY:7,rows:[{view:"pager",id:"pagerA",template:"{common.first()} {common.prev()} {common.pages()} {common.next()} {common.last()} Page {common.page()} from #limit#",size:50,group:5}]}]})},_onBeforeLoad:function(){var a=$$("table.log");a.disable();a.showOverlay("Loading <span class='webix_icon fa-spinner fa-spin'></span>")},_onAfterLoad:function(){var a=$$("table.log");a.hideOverlay();a.enable()},_onSelectChange:function(){var a=$$("table.log");var b=a.getSelectedItem();this.callEvent("onSelectChange",[b])},load:function(b){var a=webix.copy(b);a.count=50;$$("table.log").clearAll();$$("table.log").define("url",{$proxy:true,source:"/Handlers/SelectChangeLog.ashx",params:a,load:function(e,c,d){d=webix.extend(d||{},this.params||{},true);webix.ajax().bind(e).post(this.source,d,c)}})}},webix.ui.layout);webix.protoUI({name:"view.table_editor",operations:[{id:"Insert",value:"<span class='webix_icon "+app.settings.icons.insert+"'></span><span style='padding-left: 4px'>Insert</span>"},{id:"Update",value:"<span class='webix_icon "+app.settings.icons.update+"'></span><span style='padding-left: 4px'>Update</span>"},{id:"Delete",value:"<span class='webix_icon "+app.settings.icons["delete"]+"'></span><span style='padding-left: 4px'>Delete</span>"}],$init:function(b){var c=b.icons||{};var d=this;var a=function(e){return webix.bind(d[e],d)};webix.extend(this.defaults,{disabled:true,rows:[{view:"toolbar",cols:[{view:"segmented",id:"segmented.operation",optionWidth:120,value:"None",options:[],on:{onChange:a("onOperationChange")}}]},{rows:[{view:"segmented",id:"segmented.trigger",multiview:true,value:"layout.columns",options:[{value:"<span class='webix_icon fa-columns'></span><span style='padding-left: 4px'>Columns</span>",id:"layout.columns"},{value:"<span class='webix_icon fa-file-text-o'></span><span style='padding-left: 4px'>TriggerText</span>",id:"layout.triggertext"}]},{cells:[{id:"layout.columns",rows:[{view:"datatable",id:"table.columns",columns:[{id:"Checked",header:{content:"masterCheckbox",css:"center"},css:"center",template:"{common.checkbox()}",width:40},{id:"ColumnName",fillspace:true,header:"Column Name",template:function(e){if(!e.IsKey){return e.ColumnName}return"<span class='webix_icon fa-key' style='color:gold'></span> "+e.ColumnName}}],on:{onCheck:a("_onCheck")}},{height:45,cols:[{view:"button",type:"iconButton",label:"Save",icon:"floppy-o",width:95,on:{onItemClick:a("saveTable")}},{}]}]},{id:"layout.triggertext",rows:[{view:"textarea",id:"text.trigger"}]}]}]}]})},load:function(a,b){if(b){this.enable();this.params=webix.copy(a);this.params.TableName=b;this._loadTable()}else{this.clear();this.disable()}},_loadTable:function(){var a=this;var b=$$("table.columns");a.clear();webix.ajax().post("/Handlers/SelectTable.ashx",this.params,function(c){a.fillData(c)})},_getOptions:function(){var a=$$("segmented.operation");var b=a._settings||a.s;return b.options},_setOptions:function(a){var b=$$("segmented.operation");var c=b._settings||b.s;c.options=a},_refreshOptions:function(){$$("segmented.operation").refresh()},clear:function(){this.setSegmentedTableName();this.clearView();delete this.data;this._setOptions([]);this._refreshOptions()},clearView:function(){$$("table.columns").clearAll();$$("text.trigger").setValue("")},fillData:function(a){a=JSON.parse(a);this.data=a;this.records={Insert:this.buildOperationRecord("Insert"),Update:this.buildOperationRecord("Update"),Delete:this.buildOperationRecord("Delete")};this.setSegmentedTableName(a.TableName);this.setOptions()},buildOperationRecord:function(d){var a=this.data;var f=a[d];var e=[];var c=function(g){return a.KeyColumns.indexOf(g)!=-1};var b=function(g){if(!f||!f.Columns){return false}return f.Columns.indexOf(g)!=-1};a.Columns.forEach(function(g){e.push({ColumnName:g,IsKey:c(g),Checked:b(g)})});return e},setOptions:function(){var a=this.data;var c;var b=[];var d=$$("segmented.operation");this.eachOperations(function(e){var f=a[e.id];if(!f){b.push(e)}else{b.push(e);if(!c){c=e.id}}});this._setOptions(b);this._refreshOptions();c=c||"Insert";d.setValue(c);this.onOperationChange(c)},fillTriggerText:function(a){var b=this.data[a];var c="";if(b&&b.TriggerText){c=b.TriggerText}$$("text.trigger").setValue(c)},setSegmentedTableName:function(d){var b=$$("segmented.trigger"),c=b._settings||b.s;var a=c.options[0];a.value="<span class='webix_icon fa-columns'></span><span style='padding-left: 4px'>Columns "+(d||"")+"</span>";$$("segmented.trigger").refresh()},onOperationChange:function(a){this.clearView();$$("table.columns").parse(this.records[a]);this.fillTriggerText(a)},eachOperations:function(a){this.operations.forEach(a)},_onCheck:function(){var a=this.operations[$$("segmented.operation").getValue()]},saveTable:function(){var a=this.data;var b=this;["Insert","Update","Delete"].forEach(function(d){var f=b.records[d];var c=[];f.forEach(function(e){if(e.Checked){c.push(e.ColumnName)}});if(c.length==0){delete a[d]}else{if(!a[d]){a[d]={Operation:d,TableName:a.TableName}}a[d].Columns=c}});this.saveData()},saveData:function(){this.disable();var a=this.data;var b=this;var c=webix.copy(this.params);c.Table=a;webix.ajax().post("/Handlers/SaveTable.ashx",c,webix.bind(b.onSave,b))},onSave:function(a){var b=JSON.parse(a);this.callEvent("onTableChange",[b]);this.fillData(a);this.enable()}},webix.ui.layout);webix.protoUI({name:"view.table_list",$init:function(b){var c=b.icons||{};var d=this,a=function(e){return webix.bind(d[e],d)};webix.extend(this.defaults,{rows:[{view:"datatable",id:"table.table_list",select:"row",columns:[{id:"Operations",header:["Operations",{content:"selectFilter",options:[{id:"All",value:"All"},{id:"Logging",value:"Logging"},{id:"Not Logging",value:"Not Logging"}],compare:function(f,e){if(e=="All"){return true}return e=="Logging"?!!f:!f}}],width:130,template:function(f){if(!f.Operations){return""}var e=webix.template("<span class='webix_icon #icon#' style='cursor:pointer'></span>");var g=f.Operations;return g.map(function(h){return e({icon:c[h]||"fa-question"})}).join("")}},{id:"Name",fillspace:true,header:["Table",{content:"textFilter"}],sort:"string"}],on:{onBeforeLoad:a("_onBeforeLoad"),onAfterLoad:a("_onAfterLoad"),onSelectChange:a("_onSelectChange")}}]})},_onBeforeLoad:function(){var a=$$("table.table_list");a.disable();a.clearAll();a.showOverlay("Loading <span class='webix_icon fa-spinner fa-spin'></span>")},_onAfterLoad:function(){var a=$$("table.table_list");a.filterByAll();a.hideOverlay();a.enable()},_onSelectChange:function(){var a=$$("table.table_list");var b=a.getSelectedItem();var c="";if(b){c=b.Name}this.callEvent("tableSelect",[c])},load:function(a){$$("table.table_list").load("post->"+app.settings.url.tableList,null,a)},refreshItem:function(c){var b=$$("table.table_list");var a=b.data;var e=a.find(function(f){return f.Name==c.TableName},true);var d=[];["Insert","Update","Delete"].forEach(function(f){if(c[f]){d.push(f.toLowerCase())}});if(d.length==0){d=null}a.updateItem(e.id,{Operations:d})}},webix.ui.layout);webix.protoUI({name:"view.toolbar",defaultLogTable:"ChangeLog",stateName:"toolbar",minHeight:78,maxHeight:99,inserting:false,$init:function(){var b=this,a=function(c){return webix.bind(b[c],b)};webix.extend(this.defaults,{height:b.minHeight,cols:[{id:"button.add",view:"icon",icon:"plus-circle",tooltip:"Add database",click:a("toggleAdd")},{id:"layout.add",hidden:true,cols:[{width:250,id:"layout.add.text",rows:[{id:"text.server",label:"server",dataIndex:"server",view:"text",height:30,nextFocus:"text.database",on:{onKeyPress:a("onTextKeyPress")}},{id:"text.database",dataIndex:"database",label:"database",view:"text",height:30,nextFocus:"text.logtable",on:{onKeyPress:a("onTextKeyPress")}},{id:"text.logtable",dataIndex:"logtable",label:"log table",view:"text",value:this.defaultLogTable,height:30,on:{onKeyPress:a("onTextKeyPress")}}]},{width:100,rows:[{},{view:"button",type:"icon",height:30,label:"Cancel",icon:"ban",click:a("toggleAdd")},{view:"button",type:"icon",height:30,label:"Ok",icon:"check",click:a("confirmAdd")}]}]}]})},onTextKeyPress:function(e,a){switch(e){case 27:this.toggleAdd();return false;case 13:var d=a.srcElement.parentNode.parentNode.getAttribute("view_id");var b=$$(d);if(b&&b.config.nextFocus){var c=$$(b.config.nextFocus);c.focus();c.getInputNode().select();return false}this.confirmAdd();return false}},toggleAdd:function(){var b=this.inserting;var a=b?this.minHeight:this.maxHeight;$$("layout.add")[b?"hide":"show"]();$$("button.add")[b?"show":"hide"]();this.eachButtons(function(d){d[b?"enable":"disable"]()});if(!b){var c=$$("text.server");c.focus();c.getInputNode().select()}else{this.resetAddLayout()}this.define("height",a);this.resize();this.inserting=!this.inserting},resetAddLayout:function(){this.eachAddFields(function(a){a.setValue("")});$$("text.logtable").setValue(this.defaultLogTable)},eachAddFields:function(a,b){$$("layout.add.text").getChildViews().forEach(a,b||this)},eachButtons:function(a){this.getChildViews().forEach(function(b){if(b.name=="button"){a(b)}})},getTargetActivationButton:function(){var b,a=this;this.getChildViews().every(function(c){if(c.name=="button"&&a.activeButton!=c){b=c;return false}return true});return b},getAddConfig:function(){var a={};this.eachAddFields(function(b){a[b.config.dataIndex]=b.getValue()});return a},confirmAdd:function(){var b=this;var a=b.getAddConfig();b.disable();b.showOverlay("Connect <span class='webix_icon fa-spinner fa-spin'></span>");webix.ajax().post("Handlers/CheckConnection.ashx",a,function(g){b.enable();b.hideOverlay();g=JSON.parse(g);var f="";if(!g.Server){f="Bad Server name"}if(!f&&!g.Database){f="Bad Database name"}if(!f&&g.BadTableName){f="Bad Log Table name"}if(f){webix.alert({title:"Error",type:"alert-error",text:f});return}var d=b.getAddConfig();d.warning=!g.LogTable;b.toggleAdd();var e=b.addButton(d);var c=$$(e);b.activate(c);if(c.config.logCfg.warning){b.createLogTable(c)}b.saveState()})},addButton:function(a){var b=this.index($$("button.add"));var c=this.addView(this.createButton(a),b);return c},createButton:function(a){return{icon:"database",autowidth:true,view:"button",type:"htmlbutton",css:"webix_segment_N",icon:"database",logCfg:a,label:this.buildButtonLabel(a),click:webix.bind(this.onButtonClick,this)}},buildButtonLabel:function(a){var b=webix.template('</span> <span class="webix_tab_close webix_icon fa-times"></span> <span class="webix_icon fa-icon fa-database" style="font-size:18px;"></span><span> #server# #database# <br/>'+(a.warning==true?'<span class="webix_icon fa-icon fa-exclamation-triangle" style="font-size:18px; color: #ffd21a !important;">':"")+"</span>#logtable# </span> ");return b(a)},activate:function(a){if(this.activeButton){webix.html.removeCss(this.activeButton.getNode(),"webix_selected")}if(a){this.activeButton=a;webix.html.addCss(a.getNode(),"webix_selected");this.callEvent("activate",[a.config.logCfg])}else{this.activeButton=null;this.callEvent("activate",[])}},onButtonClick:function(c,b){var a=$$(c);var d=b.target||b.srcElement;switch(d.className){case"webix_tab_close webix_icon fa-times":if(this.activeButton==a){var f=this.getTargetActivationButton();this.activate(f)}this.removeView(a);this.saveState();break;case"webix_icon fa-icon fa-exclamation-triangle":this.createLogTable(a);break;default:this.activate(a);this.saveState()}},restoreState:function(){var b=this.loadState();var a=this;if(b){b.forEach(function(e){var c=e.active||false;delete e.active;var d=a.addButton(e);if(c){a.activate($$(d))}})}},getState:function(){var b=[];var a=this;this.eachButtons(function(c){var d=c.config.logCfg;if(a.activeButton&&a.activeButton==c){d.active=true}b.push(d)});return JSON.stringify(b)},saveState:function(){webix.storage.local.put(this.stateName,this.getState())},loadState:function(){var a=webix.storage.local.get(this.stateName);if(a){return JSON.parse(a)}},createLogTable:function(a){var c=this;var b=a.config.logCfg;var d="Table "+b.logtable+" not found in database "+b.database+". Create table '"+b.logtable+"'?";webix.confirm({title:"Not found table "+b.logtable,type:"confirm-warning",text:d,callback:function(e){if(e){webix.ajax().post("/Handlers/CreateTable.ashx",b,function(){a.config.logCfg.warning=false;a.define("label",c.buildButtonLabel(a.config.logCfg));a.refresh()})}}})}},webix.ui.toolbar,webix.OverlayBox);